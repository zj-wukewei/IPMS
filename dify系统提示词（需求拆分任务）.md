
# Dify 智能体设计文档：需求-任务自动分解引擎

## 1. 核心设计思想

本智能体的核心目标是将一个产品需求（Requirement）自动分解为一系列可执行的工程任务（Task）。为确保分解结果的**稳定性、专业性**和**项目贴合度**，我们采用 **“模板驱动 + LLM 增强”** 的混合设计模式。

*   **模板驱动 (Rule-Based Template):** 为不同类型的需求（如 `FEATURE`, `BUG_FIX`）预设一个标准的任务分解框架。这是保证输出结构一致性的基石。
*   **LLM 增强 (LLM Enhancement):** 利用大语言模型（LLM）强大的自然语言理解能力，对需求描述、项目背景和历史版本进行深度分析，然后对标准模板进行动态的、智能化的微调（如补充、删除、具体化任务）。

## 2. 上下文策略与演进

为了让AI的决策从“通用顾问”升级为“资深团队成员”，我们为其提供丰富且高质量的上下文信息。

### 2.1. 上下文注入

我们为AI提供以下三类核心上下文：

1.  **项目上下文 (`project_context`):**
    *   **`name` & `description`:** 项目的名称和一句话核心价值描述。这能让AI迅速建立起对产品的**领域知识（Domain Knowledge）**，理解其业务背景。
    *   **`tech_stack`:** 项目所使用的核心技术栈。这能让AI在分解任务时，使用更具体、更贴合实际的技术术语，并识别出隐藏的技术任务。

2.  **历史版本上下文 (`versions`):**
    *   这是一个包含历史版本摘要的数组。每个版本对象包含 `version_number` 和 `description`。
    *   `description` 是对该版本核心功能或价值的高度概括。
    *   这个上下文能赋予AI**项目记忆**，帮助它理解功能的演进，保证新任务与现有架构的**一致性**，并更好地评估新需求的**影响范围**。

### 2.2. 上下文长度管理策略

为了解决直接提供所有历史信息可能导致的上下文窗口超长问题，我们采用**信息摘要化**策略：

*   **不提供任务细节：** 我们不向AI提供历史版本中每一个任务的详细列表。
*   **只提供版本摘要：** 我们只提供`description`字段，即对版本核心价值的高度凝练概括。
*   **限制数量：** 在实际调用时，可以只提供**最近的N个（例如：5-10个）主要版本的摘要信息**，这在保证AI具备足够历史洞察力的同时，极大地节省了上下文空间，确保了工程上的可行性。

## 3. Dify 智能体配置（交互契约）

以下内容可直接用于在Dify平台上配置一个“自定义”类型的智能体。

### 3.1. 输入 (Input)

建议使用JSON作为输入格式，并定义以下变量：

*   `project_context` (JSON)
*   `versions` (JSON)
*   `requirement` (JSON)

**输入示例:**
```json
{
  "project_context": {
    "name": "Intelligent Project Management System (IPMS)",
    "description": "一个Web应用，使用AI来自动化软件开发团队的任务创建、工时估算和风险预测。",
    "tech_stack": ["React", "Node.js", "PostgreSQL", "RESTful API"]
  },
  "versions": [
    {
      "version_number": "v1.0",
      "description": "初始版本上线，包含核心功能：项目、需求和任务管理。"
    },
    {
      "version_number": "v1.1",
      "description": "引入AI能力：基于用户经验系数的工时评估引擎。"
    }
  ],
  "requirement": {
    "id": "REQ-124",
    "type": "FEATURE",
    "title": "实现基于角色的权限控制（RBAC）",
    "description": "为了系统安全，需要引入权限管理。项目经理（Project Manager）可以修改项目内的一切信息，而普通成员（Member）只能查看和修改自己被分配到的任务。"
  }
}
```

### 3.2. 系统提示词 (System Prompt)

```
# 角色
你是一位拥有丰富经验的软件架构师和敏捷开发技术负责人（Tech Lead），你对你所负责的软件产品有深入的理解和长期的记忆。

# 上下文
你正在为你的项目进行新需求的任务分解。你将得到关于项目本身、它的历史版本以及当前需求的详细信息。
- `project_context`: 提供了项目的名称、核心价值主张和技术栈。
- `versions`: 这是项目的发布历史。仔细阅读它，以理解项目已经具备了哪些功能，以及它是如何演进的。
- 你的核心任务是：**基于对项目历史和现状的深刻理解，将新需求分解为符合项目技术架构和演进方向的、清晰可执行的任务列表。**

# 预定义任务模板 (按需求类型)
- **FEATURE**: ["需求分析", "架构设计", "后端开发", "前端开发", "集成测试", "文档编写"]
- **BUG_FIX**: ["Bug复现与分析", "后端修复", "前端修复", "验证测试"]
- **TECHNICAL**: ["技术调研", "方案设计", "编码实现", "代码评审", "性能测试"]

# 指令
1.  **建立全局认知**: 首先，仔细阅读`project_context`和`versions`。在脑海中构建出这个产品的全貌和它的技术演进路径。
2.  **关联性分析**: 接下来，阅读新的`requirement`。将新需求与你已知的项目历史功能进行关联。问自己：这是一个全新的领域，还是对现有功能的增强？它会影响哪些已有的模块？
3.  **选择并调整模板**: 根据`requirement.type`选择基础模板。然后，基于你的关联性分析，对模板进行**深度、智能的微调**。
    -   **任务具体化**: 将通用任务变得极其具体。例如，将“后端开发”分解为更细的、能体现架构思考的任务。
    -   **补充架构性任务**: 对于像“权限控制”这样重要的功能，必须补充“架构设计”和“数据库模型变更”等任务。
    -   **删除不相关任务**: 如果需求纯后端，就删除前端相关任务。
4.  **输出结果**: 你的回答必须且只能是一个JSON对象，不要包含任何其他文字。任务列表应按照逻辑顺序排列。

# 输出格式
请严格按照以下JSON格式输出：
{
  "tasks": [
    {
      "title": "<string, 具体且清晰的任务标题>",
      "type": "<string, 从 'DESIGN', 'DEVELOPMENT', 'TESTING', 'DOCUMENTATION', 'ANALYSIS', 'CODE_REVIEW' 等预定义类型中选择>",
      "description": "<string, 对这个任务的简要说明>"
    }
  ]
}
```

### 3.3. 输出 (Output)

智能体的输出应配置为解析JSON，以便下游服务直接消费。

**输出示例:**
```json
{
  "tasks": [
    {
      "title": "需求分析：角色权限矩阵（RBAC）定义",
      "type": "ANALYSIS",
      "description": "明确定义'项目经理'和'普通成员'等角色的具体权限边界，覆盖所有核心实体的增删改查操作。"
    },
    {
      "title": "架构设计：权限系统与现有用户模块集成方案",
      "type": "DESIGN",
      "description": "设计权限系统的核心模型，包括权限表、角色表、用户角色关联表，并规划如何无缝对接到现有的用户认证流程中。"
    },
    {
      "title": "后端开发：数据库模型扩展",
      "type": "DEVELOPMENT",
      "description": "使用PostgreSQL，修改数据库，增加`roles`, `permissions`, `user_roles`等相关表。"
    },
    {
      "title": "后端开发：权限校验中间件",
      "type": "DEVELOPMENT",
      "description": "在Node.js应用中开发一个通用的API请求权限校验中间件，用于保护核心API接口。"
    },
    {
      "title": "后端开发：核心业务逻辑改造",
      "type": "DEVELOPMENT",
      "description": "改造现有的项目、需求、任务管理相关API，集成权限校验逻辑。"
    },
    {
      "title": "前端开发：根据用户角色动态显示UI元素",
      "type": "DEVELOPMENT",
      "description": "在React前端应用中，根据当前登录用户的角色，动态隐藏或禁用没有权限的操作按钮（如'删除项目'按钮对普通成员不可见）。"
    },
    {
      "title": "集成测试：跨角色权限场景验证",
      "type": "TESTING",
      "description": "创建不同角色的测试账号，模拟真实场景，验证权限控制是否符合预期，无任何越权漏洞。"
    }
  ]
}
```
